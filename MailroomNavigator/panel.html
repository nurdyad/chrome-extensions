<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BetterLetter All-in-One</title>
  <link rel="stylesheet" href="css/utilities.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/inputs.css">
  <link rel="stylesheet" href="css/status.css">
</head>
<body>
  <div class="extension-wrapper"> 
    <div class="btn-row global-nav-buttons-row">
      <button id="navigatorGlobalToggleBtn" class="btn active-tab">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Navigator
      </button>
      <button id="jobManagerGlobalToggleBtn" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </svg>
        Job Panel
      </button>
      <button id="emailFormatterGlobalToggleBtn" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7" rx="1"></rect>
          <rect x="14" y="3" width="7" height="7" rx="1"></rect>
          <rect x="3" y="14" width="7" height="7" rx="1"></rect>
          <path d="M14 17h7"></path>
          <path d="M17.5 14v7"></path>
        </svg>
        Others
      </button>
    </div>

    <div id="practiceNavigatorView" class="view-transition">
      <h1>
        Practice Navigator
        <span id="liveIndicator" class="live-dot" title="Auto-scan active"></span>
      </h1>
      
      <div style="margin-bottom: 15px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
          <label for="practiceInput" style="margin-bottom: 0; flex-shrink: 0;">Create or View practices and users</label>
          <div style="display: flex; gap: 4px;"> <button id="createPracticeAdminBtn" class="btn btn-sm" title="New Practice">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              </button>
              <button id="usersBtn" class="btn btn-sm" disabled title="View Users">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              </button>
              <button id="practicesBtn" class="btn btn-sm" title="All Practices">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              </button>
          </div>
        </div>

        <div class="search-container" style="position: relative;">
          <div class="input-with-button" style="margin-bottom: 0;">
            <input id="practiceInput" placeholder="Enter Practice Name or ODS code" autocomplete="off">
            <button id="resetSettingsBtn" class="btn btn-sm btn-icon" title="Reset">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2.5 2v6h6M21.5 22v-6h-6"></path>
                <path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path>
              </svg>
            </button>
          </div>
          <ul id="suggestions"></ul>
        </div>
      </div>

      <div class="action-grid">
        <button id="collectionBtn" class="btn btn-sm" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
          Collection
        </button>

        <button id="preparingBtn" class="btn btn-sm" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Preparing
        </button>

        <button id="rejectedBtn" class="btn btn-sm" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Rejected
        </button>

        <button id="openEhrSettingsBtn" class="btn btn-sm" disabled style="background-color: #6c757d;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
          Settings
        </button>

        <button id="taskRecipientsBtn" class="btn btn-sm" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          Task Recipients
        </button>
      </div>

      <div class="section-container">
        <div class="jobs-row">
          <div class="job-col">
            <label for="docmanJobSelectNav">Docman Jobs</label>
            <select id="docmanJobSelectNav">
              <option value="">Select Docman job…</option>
              <option value="generate_output">Generate Output</option>
              <option value="docman_validate">Docman Validate</option>
              <option value="docman_import">Docman Import</option>
              <option value="docman_file">Docman File</option>
              <option value="merge_tasks_for_same_recipient">Merge Tasks for Same Recipient</option>
              <option value="publish_tasks">Publish Tasks</option>
              <option value="docman_review">Docman Review</option>
              <option value="docman_delete_original">Docman Delete Original</option>
              <option value="docman_upload">Docman Upload</option>
              <option value="docman_rejection">Docman Rejection</option>
            </select>
          </div>

          <div class="job-col">
            <label for="emisJobSelectNav">EMIS Jobs</label>
            <select id="emisJobSelectNav">
              <option value="">Select EMIS job…</option>
              <option value="emis_api_consultation">EMIS API Consultation</option>
              <option value="emis_unmatch">EMIS Unmatch</option>
              <option value="emis_prepare">EMIS Prepare</option>
              <option value="emis_delete_originals">EMIS Delete Originals</option>
              <option value="emis_rejection">EMIS Rejection</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="search-container" style="position: relative; width: 100%; max-width: 100%;">
        <label for="cdbSearchInput">Search by Practice CDB</label>
        <div class="input-with-button" style="margin-bottom: 0;">
          <input id="cdbSearchInput" placeholder="Enter Practice CDB" autocomplete="off">
        </div>
        <ul id="cdbSuggestions"></ul> 
      </div>
      <div id="cdbSearchResult"></div>
      <div id="status"></div>
      <div id="statusDisplay"></div>
    </div>

    <div id="jobManagerView" class="job-manager-container view-transition" style="display: none; width: 100%;">
  
      <div class="section-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 style="margin: 0;">Quick Document Search</h3>
            <span id="pasteStatus" style="font-size: 10px; color: #28a745; font-weight: normal; opacity: 0; transition: opacity 0.3s;">Pasted!</span>
        </div>
        
        <div class="input-with-button">
          <input type="text" id="manualDocId" placeholder="Paste or type ID..." autocomplete="off">
        </div>
        <div id="manualDocValidation" class="validation-badge neutral">Enter a numeric Document ID.</div>

        <div class="copy-row">
          <button id="copyJobsUrlBtn" class="btn btn-sm btn-ghost">Copy Jobs URL</button>
          <button id="copyObanUrlBtn" class="btn btn-sm btn-ghost">Copy Oban URL</button>
          <button id="copyLogUrlBtn" class="btn btn-sm btn-ghost">Copy Log URL</button>
          <button id="copyAdminUrlBtn" class="btn btn-sm btn-ghost">Copy Admin URL</button>
        </div>
        
        <div class="button-grid" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button id="btnJobs" class="btn btn-sm" style="background: #6c757d;">Jobs</button>
            <button id="btnOban" class="btn btn-sm" style="background: #fd7e14;">Oban</button>
            <button id="btnLog" class="btn btn-sm" style="background: #17a2b8;">Log</button>
            <button id="btnAdmin" class="btn btn-sm" style="background: #007bff;">Admin</button>
        </div>
      </div>

      <div class="section-container">
        <h3>Single ID Status Check</h3>
        <label for="jobStatusInput">Job ID:</label>
        <div class="input-with-button">
          <input id="jobStatusInput" placeholder="Enter Job ID..." autocomplete="off">
        </div>
        <div id="jobStatusValidation" class="validation-badge neutral">Enter a numeric Job ID.</div>
        <div class="copy-row">
          <button id="copyJobStatusUrlBtn" class="btn btn-sm btn-ghost">Copy Job ID</button>
          <button id="copyJobStatusLinkBtn" class="btn btn-sm btn-ghost">Copy Job Link</button>
        </div>
        <div class="button-grid" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <button id="openJobStatusBtn" class="btn btn-sm">Open Status</button>
          <button id="clearJobStatusInputBtn" class="btn btn-sm">Clear</button>
        </div>
      </div>

      <div class="section-container">
        <h3>Bulk ID Actions</h3>
        <label for="bulkIdsInput">Paste multiple Document IDs (comma/space/new line)</label>
        <textarea id="bulkIdsInput" class="bulk-input" placeholder="e.g. 12345, 67890"></textarea>
        <div id="bulkIdsValidation" class="validation-badge neutral">No IDs detected yet.</div>
        <div class="bulk-controls">
          <select id="bulkActionType">
            <option value="jobs">Jobs</option>
            <option value="oban">Oban</option>
            <option value="log">Log</option>
            <option value="admin">Admin</option>
          </select>
          <button id="openBulkActionBtn" class="btn btn-sm">Open All</button>
          <button id="copyBulkActionBtn" class="btn btn-sm btn-icon-only" title="Copy all links" aria-label="Copy all links">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M10 13a5 5 0 0 0 7.07 0l2.83-2.83a5 5 0 1 0-7.07-7.07L11 4"></path>
              <path d="M14 11a5 5 0 0 0-7.07 0L4.1 13.83a5 5 0 0 0 7.07 7.07L13 19"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="section-container">
        <h3>Recent IDs</h3>
        <label>Recent Document IDs</label>
        <div id="recentDocIdsChips" class="chips-row"></div>
        <label style="margin-top: 8px;">Recent Job IDs</label>
        <div id="recentJobIdsChips" class="chips-row"></div>
      </div>

    </div>

    <div id="emailFormatterView" class="email-formatter-container view-transition" style="display: none;">

      <div class="section-container">
        <h3>Email Formatter</h3>
        <textarea id="inputEmailFormatter" placeholder="Paste email addresses here..."></textarea>
        <div class="button-grid" style="margin-bottom: 12px;">
          <button id="convertEmailBtn" class="btn btn-sm">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
            </svg>
            Convert
          </button>
          <button id="nameOnlyBtn" class="btn btn-sm">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>
            </svg>
            Name
          </button>
        </div>
        <textarea id="outputEmailFormatter" readonly placeholder="Comma-separated output..."></textarea>
        <button id="copyEmailBtn" class="btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
      </div>

      <div class="section-container" style="margin-top: 12px;">
        <h3>Custom Workflow Groups</h3>
        <label for="workflowNamesInput">Paste workflow names (one per line, or paste Airtable rows)</label>
        <textarea id="workflowNamesInput" class="bulk-input" placeholder="e.g.
John Smith
Mike Drinkwater"></textarea>
        <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 8px;">
          <label style="margin: 0;"><input type="checkbox" id="workflowSkipDuplicates" checked> Skip existing workflow names</label>
          <label style="margin: 0;"><input type="checkbox" id="workflowTitleCase"> Convert names to Title Case</label>
        </div>
        <div id="workflowStatus" class="validation-badge neutral" style="margin-top: 8px; white-space: pre-wrap;">Ready.</div>
        <div id="workflowProgressTrack" style="width:100%; height:8px; background:#e5e7eb; border-radius:6px; overflow:hidden; margin-top:8px; display:none;">
          <div id="workflowProgressBar" style="height:100%; width:0%; background:#16a34a; transition: width 0.2s;"></div>
        </div>
        <div class="button-grid" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <button id="runWorkflowBulkBtn" class="btn btn-sm">Run Bulk Create</button>
          <button id="testWorkflowParseBtn" class="btn btn-sm">Test Parse</button>
        </div>
      </div>

      <div class="section-container">
        <h3>Bookmarklet Tools</h3>
        <label>Run on the active BetterLetter tab</label>
        <div class="button-grid" style="margin-top: 10px; display: grid; grid-template-columns: 1fr; gap: 8px;">
          <button id="runUuidPickerToolBtn" class="btn btn-sm">UUID Picker</button>
          <button id="runListDocmanGroupsToolBtn" class="btn btn-sm">Get Docman Group Names</button>
        </div>
      </div>
    </div>

  </div> 
  <div id="toast" aria-live="polite" aria-atomic="true"></div>
  <script type="module" src="panel.js"></script>
</body>
</html>
